<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>CBT App</title>
<style>
  /* Mobile-first JAMB/WAEC-style theme: clean, white card, green accents */
  :root{
    --accent:#0b6b3a;
    --accent-2:#2a8f57;
    --muted:#666;
    --card-radius:12px;
    --max-width:720px;
  }
  html,body{height:100%;margin:0;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;}
  body{background:linear-gradient(#f6fbf6, #ffffff); display:flex; align-items:center; justify-content:center; padding:20px;}
  .app{width:100%; max-width:var(--max-width); box-shadow:0 6px 24px rgba(10,10,10,0.08); border-radius:16px; overflow:hidden; background:#fff;}
  header{padding:18px 16px; background:linear-gradient(90deg,var(--accent),var(--accent-2)); color:#fff;}
  header h1{margin:0;font-size:18px; font-weight:700;}
  header p{margin:6px 0 0;font-size:13px; opacity:0.95;}
  .container{padding:16px;}
  .field{margin-bottom:14px;}
  label{display:block;font-size:13px;color:var(--muted); margin-bottom:6px;}
  select,input[type=number],input[type=text]{width:100%; padding:12px;border-radius:8px;border:1px solid #e6e6e6;font-size:15px; box-sizing:border-box;}
  .row{display:flex; gap:12px;}
  .row .field{flex:1;}
  button.primary{background:var(--accent); color:#fff; border:none; padding:12px 14px; border-radius:10px; font-weight:700; width:100%;}
  button.ghost{background:transparent; border:1px solid #ddd; padding:10px 12px; border-radius:8px;}
  .meta{display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:12px;}
  .card{background:#fff;border-radius:12px;padding:12px;border:1px solid #f0f0f0; margin-bottom:12px;}
  .question{font-weight:700;font-size:16px;margin-bottom:10px;}
  .options{display:grid; gap:8px;}
  .option{display:flex; align-items:flex-start; gap:10px; padding:10px; border-radius:10px; border:1px solid #eee; cursor:pointer; background:#fafafa;}
  .option input{margin-top:3px;}
  .controls{display:flex; gap:10px; margin-top:12px;}
  .controls button{flex:1;}
  .timer{font-weight:700; color:var(--accent);}
  .small{font-size:13px;color:var(--muted);}
  .result{padding:16px;}
  .wrong{border-left:4px solid #e94b3c; padding:10px; margin-bottom:8px; border-radius:8px; background:#fff6f6;}
  .correct{border-left:4px solid #2aa85a; padding:10px; margin-bottom:8px; border-radius:8px; background:#f6fff6;}
  .highlight{font-weight:700; color:var(--accent);}
  footer{padding:12px 16px;background:#fafafa; display:flex; gap:8px;}
  @media (min-width:720px){
    body{padding:32px;}
  }
  .muted-line{font-size:13px;color:#888;margin-bottom:12px;}
</style>
</head>
<body>
  <div class="app" role="application" aria-labelledby="app-title">
    <header>
      <h1 id="app-title">CBT Examination</h1>
      <p>Instructions</p>
    </header>

    <div class="container" id="app">
      <!-- START: Setup screen -->
      <div id="setup-screen">
        <div class="card">
          <div class="field">
            <div class="small"> </div>
          </div>

          <div class="field">
            <label for="examType">Exam Type</label>
            <select id="examType"><option value="">Loading...</option></select>
          </div>

          <div class="row">
            <div class="field">
              <label for="subject">Subject</label>
              <select id="subject"><option value="">Loading...</option></select>
            </div>
            <div class="field">
              <label for="year">Year</label>
              <select id="year"><option value="">Loading...</option></select>
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label for="noQuestions">Number of questions</label>
              <input id="noQuestions" type="number" min="1" placeholder="e.g. 20" value="20" />
            </div>
            <div class="field">
              <label for="duration">Duration (minutes)</label>
              <input id="duration" type="number" min="1" placeholder="e.g. 30" value="30" />
            </div>
          </div>

          <div class="field">
            <label for="candidateName">Candidate name (optional)</label>
            <input id="candidateName" type="text" placeholder="e.g. Jane Doe" />
          </div>

          <div style="display:flex; gap:10px; margin-top:8px;">
            <button id="startBtn" class="primary">Start Exam</button>
            <button id="reloadBtn" class="ghost">Reload Questions</button>
          </div>
        </div>
        <div class="small muted-line">Tip: Use the filters above (exam type, subject, year). Question pool is taken from your sheet and randomised for the selected count.</div>
      </div>
      <!-- END Setup screen -->

      <!-- START: Question screen -->
      <div id="question-screen" style="display:none;">
        <div class="meta">
          <div class="small">Q <span id="qIndex">1</span> of <span id="qTotal">10</span></div>
          <div class="timer" id="timer">00:00</div>
        </div>

        <div class="card">
          <div class="question" id="questionText">Question text</div>
          <div class="options" id="optionsContainer"></div>
          <div class="small" id="explainHint" style="display:none;margin-top:8px;">(Use Back to change answers.)</div>
          <div class="controls">
            <button id="backBtn" class="ghost">Back</button>
            <button id="nextBtn" class="primary" disabled>Next</button>
          </div>
        </div>
      </div>
      <!-- END Question screen -->

      <!-- START: Result screen -->
      <div id="result-screen" style="display:none;">
        <div class="card result" id="resultCard">
          <h2 id="scoreTitle">You scored 0 / 0</h2>
          <div class="small" id="scorePercent">0%</div>
          <div style="margin-top:12px;">
            <button id="retryBtn" class="primary">Take another test</button>
            <button id="viewAnswersBtn" class="ghost">View answers</button>
          </div>
        </div>

        <div id="answersList" style="display:none; padding:0 16px 16px;">
          <h3 class="small" style="margin-bottom:8px;">Wrong questions and correct answers</h3>
          <div id="wrongContainer"></div>
        </div>
      </div>
      <!-- END Result screen -->

    </div>

    <footer>
      <div class="small"></div>
    </footer>
  </div>

<script>
(function(){
  // --- CONFIG: use your published Google Sheet link (CSV)
  const sheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSDcBKJMee5gQ3J7gWwn04wzYVMrZFMzthqABaNGoglWdG-xrkdl0b4pSdnnZvJ-rOU_wvxTLUk6cEa/pub?output=csv';

  // DOM refs
  const examTypeEl = document.getElementById('examType');
  const subjectEl = document.getElementById('subject');
  const yearEl = document.getElementById('year');
  const noQuestionsEl = document.getElementById('noQuestions');
  const durationEl = document.getElementById('duration');
  const startBtn = document.getElementById('startBtn');
  const reloadBtn = document.getElementById('reloadBtn');
  const setupScreen = document.getElementById('setup-screen');
  const questionScreen = document.getElementById('question-screen');
  const resultScreen = document.getElementById('result-screen');
  const qIndexEl = document.getElementById('qIndex');
  const qTotalEl = document.getElementById('qTotal');
  const timerEl = document.getElementById('timer');
  const questionTextEl = document.getElementById('questionText');
  const optionsContainer = document.getElementById('optionsContainer');
  const backBtn = document.getElementById('backBtn');
  const nextBtn = document.getElementById('nextBtn');
  const scoreTitle = document.getElementById('scoreTitle');
  const scorePercent = document.getElementById('scorePercent');
  const retryBtn = document.getElementById('retryBtn');
  const viewAnswersBtn = document.getElementById('viewAnswersBtn');
  const wrongContainer = document.getElementById('wrongContainer');
  const answersList = document.getElementById('answersList');
  const candidateNameEl = document.getElementById('candidateName');

  // State
  let rawQuestions = [], pool = [], examQuestions = [], answers = [], currentIndex = 0, timerInterval = null, timeRemaining = 0;

  // ---------------- CSV parsing ----------------
  function parseCSV(text){
    const rows = [];
    let cur = '', row = [], i=0, inQuotes=false;
    while(i < text.length){
      const ch = text[i];
      if(inQuotes){
        if(ch === '"'){
          if(text[i+1] === '"'){ cur += '"'; i+=2; continue; }
          inQuotes=false; i++; continue;
        } else { cur += ch; i++; continue; }
      } else {
        if(ch === '"'){ inQuotes=true; i++; continue; }
        if(ch === ','){ row.push(cur); cur=''; i++; continue; }
        if(ch === '\r'){ i++; continue; }
        if(ch === '\n'){ row.push(cur); cur=''; rows.push(row); row=[]; i++; continue; }
        cur += ch; i++;
      }
    }
    if(cur!=='' || row.length>0){ row.push(cur); rows.push(row); }
    return rows;
  }

  function rowsToObjects(rows){
    if(!rows || rows.length===0) return [];
    const header = rows[0].map(h=>String(h||'').trim());
    const out=[];
    for(let r=1;r<rows.length;r++){
      const row = rows[r];
      if(row.every(c=>(c||'').trim()==='')) continue;
      const obj={};
      for(let c=0;c<header.length;c++) obj[header[c]] = (row[c]||'').trim();
      out.push(obj);
    }
    return out;
  }

  // ---------------- Helpers ----------------
  function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
  function shuffle(arr){ const a=arr.slice(); for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }

  // normalize correct answer text (returns the option text for the correct answer)
  function getCorrectOptionTextFromRow(row){
    const raw = String(row.correct_answer||'').trim();
    if(!raw) return '';
    const up = raw.toUpperCase();
    // if user stored 'A'/'B' etc
    if(['A','B','C','D'].includes(up)) {
      const key = {A:'option_a',B:'option_b',C:'option_c',D:'option_d'}[up];
      return String(row[key]||'').trim();
    }
    // maybe they used header names like "option_a"
    if(['OPTION_A','OPTION_B','OPTION_C','OPTION_D'].includes(up)){
      const map = {'OPTION_A':'option_a','OPTION_B':'option_b','OPTION_C':'option_c','OPTION_D':'option_d'};
      return String(row[map[up]]||'').trim();
    }
    // else maybe they wrote the actual answer text in the cell
    return String(row.correct_answer||'').trim();
  }

  // ---------------- Fetch sheet ----------------
  async function fetchSheetData(){
    try{
      examTypeEl.innerHTML='<option>Loading...</option>';
      subjectEl.innerHTML='<option>Loading...</option>';
      yearEl.innerHTML='<option>Loading...</option>';
      const res = await fetch(sheetUrl);
      if(!res.ok) throw new Error('Failed to fetch sheet. Ensure it is public.');
      const text = await res.text();
      const rows = parseCSV(text);
      const objs = rowsToObjects(rows);
      return objs;
    } catch(err){ alert('Error fetching sheet: '+err.message); console.error(err); return []; }
  }

  function populateFilters(data){
    rawQuestions = data;
    if(!rawQuestions || rawQuestions.length===0){
      examTypeEl.innerHTML='<option>No questions found</option>';
      subjectEl.innerHTML='<option>—</option>';
      yearEl.innerHTML='<option>—</option>';
      return;
    }
    const types=new Set(), subjects=new Set(), years=new Set();
    rawQuestions.forEach(q=>{ if(q.exam_type) types.add(q.exam_type); if(q.subject) subjects.add(q.subject); if(q.year) years.add(q.year); });
    const makeOptions = (set)=>['<option value="">— choose —</option>'].concat(Array.from(set).sort().map(v=>`<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`)).join('');
    examTypeEl.innerHTML = makeOptions(types);
    subjectEl.innerHTML = makeOptions(subjects);
    yearEl.innerHTML = makeOptions(years);
  }

  // ---------------- Option shuffle + remap ----------------
  function shuffleQuestionOptions(row){
    // row is raw row from sheet. We create an object:
    const originalOptions = [
      {label:'A', key:'option_a', text: String(row.option_a||'').trim()},
      {label:'B', key:'option_b', text: String(row.option_b||'').trim()},
      {label:'C', key:'option_c', text: String(row.option_c||'').trim()},
      {label:'D', key:'option_d', text: String(row.option_d||'').trim()}
    ];

    const correctText = getCorrectOptionTextFromRow(row);

    // shuffle the array
    const shuffled = shuffle(originalOptions);

    // map to new letters A-D
    const letters = ['A','B','C','D'];
    const newOptions = {};
    let newCorrectLetter = '';
    for(let i=0;i<letters.length;i++){
      const letter = letters[i];
      newOptions[letter] = shuffled[i].text;
      // compare trimmed, case-insensitive to find new correct letter
      if(String(shuffled[i].text || '').trim().toLowerCase() === String(correctText || '').trim().toLowerCase()){
        newCorrectLetter = letter;
      }
    }

    // if we couldn't find correctText match (e.g. correct was 'B'), try using original letter mapping:
    if(!newCorrectLetter){
      const raw = String(row.correct_answer||'').trim().toUpperCase();
      if(['A','B','C','D'].includes(raw)) {
        // find text for that letter in originalOptions, then find matching shuffled
        const originalCorrectText = originalOptions.find(o=>o.label===raw)?.text || '';
        for(let i=0;i<letters.length;i++){
          if(String(shuffled[i].text||'').trim().toLowerCase() === String(originalCorrectText||'').trim().toLowerCase()){
            newCorrectLetter = letters[i];
            break;
          }
        }
      }
    }

    // Fallback: if still not found, set to empty (won't count as correct)
    return {
      question: String(row.question||'').trim(),
      options: newOptions, // {A: 'text', B: 'text', ...}
      correct: newCorrectLetter, // 'A'|'B'|'C'|'D' or '' if unknown
      meta: { exam_type: row.exam_type, subject: row.subject, year: row.year }
    };
  }

  // ---------------- Start exam ----------------
  function startExam(){
    const examType = examTypeEl.value;
    const subject = subjectEl.value;
    const year = yearEl.value;
    const noQ = Math.max(1, parseInt(noQuestionsEl.value || '10', 10));
    const minutes = Math.max(1, parseInt(durationEl.value || '10', 10));

    // filter rows by selected filters and ensure required option fields exist
    pool = rawQuestions.filter(q=>{
      if(examType && String(q.exam_type||'') !== examType) return false;
      if(subject && String(q.subject||'') !== subject) return false;
      if(year && String(q.year||'') !== year) return false;
      // require at least question and four options and some correct_answer value
      if(!(q.question && q.option_a && q.option_b && q.option_c && q.option_d && q.correct_answer)) return false;
      return true;
    });

    if(pool.length === 0){ alert('No questions match filters'); return; }

    // Randomize question order
    const chosenPool = shuffle(pool).slice(0, Math.min(noQ, pool.length));

    // Shuffle options inside each chosen question and remap correct letter
    examQuestions = chosenPool.map(q => shuffleQuestionOptions(q));

    // init answers, timer, UI
    answers = new Array(examQuestions.length).fill(null);
    currentIndex = 0;
    timeRemaining = minutes * 60;
    startTimer();
    setupScreen.style.display = 'none';
    questionScreen.style.display = '';
    resultScreen.style.display = 'none';
    renderQuestion();
  }

  // ---------------- Timer ----------------
  function startTimer(){ 
    if(timerInterval) clearInterval(timerInterval);
    updateTimerDisplay(); 
    timerInterval = setInterval(()=>{
      timeRemaining--;
      updateTimerDisplay();
      if(timeRemaining <= 0){
        clearInterval(timerInterval);
        submitExam();
      }
    }, 1000);
  }
  function updateTimerDisplay(){ const mm = String(Math.floor(timeRemaining/60)).padStart(2,'0'); const ss = String(timeRemaining%60).padStart(2,'0'); timerEl.textContent = mm + ':' + ss; }

  // ---------------- Render question ----------------
  function renderQuestion(){
    const q = examQuestions[currentIndex];
    qIndexEl.textContent = (currentIndex + 1);
    qTotalEl.textContent = examQuestions.length;
    questionTextEl.innerHTML = escapeHtml(q.question);

    optionsContainer.innerHTML = '';
    ['A','B','C','D'].forEach(letter=>{
      const txt = q.options[letter] || '';
      // create option element
      const option = document.createElement('label');
      option.className = 'option';
      option.tabIndex = 0;
      option.innerHTML = `<input type="radio" name="opt" value="${letter}" ${answers[currentIndex]===letter ? 'checked' : ''} />
        <div style="flex:1;"><div style="font-weight:700">${letter}.</div><div style="margin-top:4px;">${escapeHtml(txt)}</div></div>`;
      option.addEventListener('click', ()=> {
        option.querySelector('input').checked = true;
        answers[currentIndex] = letter;
        nextBtn.disabled = false;
      });
      option.addEventListener('keypress', e=>{ if(e.key==='Enter' || e.key===' '){ option.click(); e.preventDefault(); } });
      optionsContainer.appendChild(option);
    });

    backBtn.disabled = (currentIndex === 0);
    nextBtn.textContent = (currentIndex === examQuestions.length - 1 ? 'Submit' : 'Next');
    nextBtn.disabled = (answers[currentIndex] === null);
  }

  // ---------------- Navigation ----------------
  function onNext(){
    if(currentIndex === examQuestions.length - 1){
      if(confirm('Submit exam now?')) submitExam();
      return;
    }
    currentIndex++;
    renderQuestion();
  }
  function onBack(){
    if(currentIndex === 0) return;
    currentIndex--;
    renderQuestion();
  }

  // ---------------- Submit ----------------
  function submitExam(){
    if(timerInterval) { clearInterval(timerInterval); timerInterval = null; }
    let correctCount = 0;
    const wrongs = [];

    for(let i=0;i<examQuestions.length;i++){
      const user = String((answers[i]||'')).toUpperCase();
      const correct = String((examQuestions[i].correct||'')).toUpperCase();
      if(user !== '' && user === correct && ['A','B','C','D'].includes(correct)){
        correctCount++;
      } else {
        wrongs.push({
          index: i,
          question: examQuestions[i].question,
          options: examQuestions[i].options,
          correct: correct || '(unknown)',
          selected: user || '-'
        });
      }
    }

    scoreTitle.textContent = `You scored ${correctCount} / ${examQuestions.length}`;
    scorePercent.textContent = `${Math.round(100 * correctCount / examQuestions.length)}%`;
    wrongContainer.innerHTML = wrongs.map(w=>`<div class="wrong"><div class="highlight">Q${w.index+1}:</div> ${escapeHtml(w.question)}<br><strong>Correct:</strong> ${escapeHtml(w.correct)} &nbsp; <strong>Your:</strong> ${escapeHtml(w.selected)}</div>`).join('');
    questionScreen.style.display = 'none';
    resultScreen.style.display = '';
  }

  // ---------------- UI events ----------------
  startBtn.addEventListener('click', startExam);
  reloadBtn.addEventListener('click', initLoadQuestions);
  nextBtn.addEventListener('click', onNext);
  backBtn.addEventListener('click', onBack);
  retryBtn.addEventListener('click', ()=>{ resultScreen.style.display = 'none'; setupScreen.style.display = ''; });
  viewAnswersBtn.addEventListener('click', ()=>{ answersList.style.display = answersList.style.display === 'none' ? '' : 'none'; });

  // ---------------- Initial load ----------------
  async function initLoadQuestions(){
    const data = await fetchSheetData();
    populateFilters(data);
  }
  initLoadQuestions();

})();
</script>
</body>
</html>
